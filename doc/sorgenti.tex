\chapter{Analisi Sorgenti Dati}

\section{Helbiz}

Helbiz non mette a disposizione alcuna API pubblica per l'integrazione con
i servizi offerti né rilascia open data relativi agli utilizzi dei propri
veicoli. L'unico modo per un utente di interagire con un monopattino è mediante
l'applicazione mobile.

WoBike è un progetto presente su GitHub che raccoglie grazie al contributo
di alcuni sviluppatori la documentazione alle API dei principali 
provider di servizi di mobility sharing di tutto il mondo.
Tra le varie documentazioni presenti vi è il servizio di API REST
utilizzato dall'applicazione mobile di Helbiz, ottenuto per reverse
engineering dell'applicazione Android. A seguito di analisi e di relativo
utilizzo del servizio è emerso che lo stesso è stato oggetto di aggiornamento
nel tempo e che alcune richieste, una su tutte quella di autenticazione,
è cambiata per contenuto dei parametri inviati.
Si è reso pertanto necessario, da parte di chi scrive, procedere al reverse
engineering dell'applicazione Android. Tale operazione ha permesso di
identificare la variazione intervenuta e di procedere con successo
all'utilizzo del servizio in questione. Inoltre, allo scopo di facilitare
gli altri utenti interessati a tale servizio, sono state integrate nella
documentazione già presente, le variazioni rilevate alla richiesta di
autenticazione.

Un utente che decide di noleggiar per la prima volta un monopattino
deve nell'ordine:
\begin{itemize}
\item scaricare sul proprio smartphone o tablet l'applicazione ufficiale
disponibile su Play Store o App Store;
\item registrarsi al servizio attraverso l'applicazione;
\item abilitare la geolocalizzazione e abilitare l'applicazione ad accedere
alla propria posizione;
\item una volta geolocalizzato, scegliere un monopattino, dirigersi verso
il monopattino scelto ed inquadrarne il QR Code;
\item impostare il metodo di pagamento desiderato;
\item attendere lo sblocco del mezzo prima di poterlo utilizzare.
\end{itemize}
L'interazione con il monopattino necessita di una connessione dati, di
un dispositivo di geolocalizzazione, dell'accesso ad una fotocamera
per la scansione del QR Code.

\subsection{API REST}

Di seguito procediamo alla documentazione delle due richieste utilizzate,
tralasciando la richiesta per autenticazione ed altre richieste non
utili al progetto.

Ognuna delle successive richieste deve essere provvista dei seguenti
parametri nello header: \\

\begin{tabular}{ll}
\toprule
\textbf{Chiave} & \textbf{Valore} \\
\midrule
X-Requested-With & XMLHttpRequest \\
User-Agent & Helbiz (com.helbiz.android) \\
Content-Type & application/json \\
X-access-token & risultato richiesta di autenticazione \\
\bottomrule
\end{tabular} \\

\noindent~Ogni risposta fornita dal servizio qui descritto restituisce dei
dati in formato JSON.

\subsubsection{API Region}

\textbf{Method:} \texttt{GET} \\
\textbf{Url:} \texttt{https://api.helbiz.com/prod/regions} \\

\noindent\textbf{Descrizione:} la richiesta ritorna tutte le regioni corrispondenti
a città presso le quali Helbiz opera.
Relativamente alla singola region, gli attributi utilizzati all'interno del
progetto sono:
\begin{itemize}
\item name: nome della region in oggetto;
\item bounds: lista di coppie
\end{itemize}
coordinate cartesiane entra le quali è definita l'area della regione in
questione.
A seguito di analisi è risultato che i valori riportati per gli attributi
startTime e endTime, così come il valore dell'attributo live non sono
indicativi del periodi di attività o del funzionamento del servizio
nell'area in oggetto.
Il seguente listato contiene parte delle informazioni ritornate per
la città di Torino, ove presenti i puntini di sospensione va intesa
la presenza di altri dati per brevità non riportati.

\inputminted[bgcolor=lightgray]{json}{region.json}{fontsize=\footnotesize}

\subsubsection{API Vehicles}

\textbf{Method:} \texttt{GET} \\
\textbf{Url:} \texttt{https://api.helbiz.com/prod/vehicles?northWest=coordinateNordOvest\&southEast=coordinateSudEst} \\

\begin{tabular}{lll}
\toprule
\textbf{Parametro} & \textbf{Esempio} & \textbf{Descrizione} \\
\midrule
northWest & 45,397541,7,245143 & coordinate geografiche dell'estremo Nord Ovest dell'area di interesse \\
southEast & 44,726304,8,464625 & coordinate geografiche dell'estremo Sud Est dell'area di interesse \\
\bottomrule
\end{tabular} \\

\noindent\textbf{Descrizione:} la richiesta ritorna i veicoli contenuti nell'area di interesse 
corrispondente al rettangolo avente per estremo superiore sinistro il punto specificato dal
parametro northWest e per estremo inferiore destro il punto specificato dal parametro southEast.
Relativamente al singolo veicolo, le informazioni utilizzate ai fini del progetto sono:
\begin{itemize}
\item id: identificatore del veicolo in formato di stringa alfanumerica (esedecimale);
\item lat: latitudine, numero provvisto di parte decimale di lunghezza variabile 
\item lon: longitudine, numero provvisto di parte decimale di lunghezza variabile
\item batteryLevelInMiles: autonomia in miglia della batteria, numero decimale 
\item range: valore risultante dal prodotto tra batteryLevelInMiles e 1000
\item geofence: nome della region di appartenenza
\end{itemize}
Il seguente listato contiene due veicoli di esempio ritornati interrogando il servizio
con le coordinate indicate nella precedente tabella e facenti riferimento alla region
che copre la città di Torino.

\inputminted[bgcolor=lightgray]{json}{vehicles.json}

\subsection{Progettazione concettuale}

A partire dalla API precedentemente descritta è stato scritto un applicativo Java,di cui
verrà fatta descrizione nel seguito, che partendo da una Region e da un intervallo in
minuti interroga ad intervalli regolari il servizio esposto da Helbiz per ottenere le
informazioni sui veicoli presenti in una delimitata area geografica.
In figura~\ref{fig:vehicle_profiling_er} è mostrato lo schema ER che modella le informazioni
relative alle profilazioni. Nella progettazione è stato assunto che ogni istanza
dell'entità Profiling sia univocamente identificata dall'attributo query\_time e
dall'attributo id dell'entità Vehicle.

\begin{figure}[H]                                                                                                                                                            
\centering                                                                                                                                                                   
\includegraphics[width=\textwidth]{diagrams/vehicle_profiling_er}                                                                                                                                   
\caption{Diagramma ER Vehicle-Profiling-Region}                                                                                                                                            
\label{fig:vehicle_profiling_er}                                                                                                                                                           
\end{figure}

\subsection{Progettazione logica}

Risultato della progettazione logica sono le seguenti due relazioni:
\begin{itemize}
\item \textit{Vehicles:} contenente tutti dati relativi alla profilazione di un veicolo
appartenente ad una determinata regione istante di tempo; è presnete un vincolo di integrità
referenziale per l'attributo \textit{region\_id} rispetto all'attributo \textit{id} della
relazione \textit{Regions};
\item \textit{Regions:} contenente i nomi delle regioni per le quali esistono delle
profilazioni all'interno della relazione \textit{Vehicles}.
\end{itemize}
In figura~\ref{fig:vehicles_logic_physic} è mostrato lo schema logico ottenuto mediante
l'applicativo MySQL Workbench.

Considerata a regime una differenza importante tra le due tabelle per numero di record
memorizzati, è stato valutata sconveniente l'aggiunta delle chiavi della tabella
\textit{Vehicles} alla tabella \textit{City} con conseguente aggiunta di ridondanza.
Ciò ha portato a trasformare la relazione uno a molto espressa nel precedente diagramma
ER in una relazione uno a uno.

\begin{figure}[H]                                                                                                                                                            
\centering                                                                                                                                                                   
\includegraphics[width=\textwidth]{diagrams/vehicles_logic}                                                                                                                                   
\caption{Schema logico Vehicles}                                                                                                                                            
\label{fig:vehicles_logic_physic}                                                                                                                                                           
\end{figure}

\section{Torino Meteo}

\subsection{API REST}

\subsection{Progettazione concettuale}

In figura~\ref{fig:weather_detection_er} è mostrato lo schema ER per la sorgente in oggetto.
L'entità \textit{Weather sensor} è univocamente identificata dagli attributi id e detection\_time.

\begin{figure}[H]                                                                                                                                                            
\centering                                                                                                                                                                   
\includegraphics[width=\textwidth]{diagrams/weather_detection_er}                                                                                                                                   
\caption{Diagramma ER Weather sensor-City}                                                                                                                                            
\label{fig:weather_detection_er}                                                                                                                                                           
\end{figure}

\subsection{Progettazione logica}

Si è scelto di creare le seguenti due relazioni:
\begin{itemize}
\item \textit{Weather dectection:} contenente tutti i dati ottenuti interrogando un sensore;
l'attributo è stato posto un vincolo di integrità referenziale sull'attributo
\textit{city\_id} verso la relazione \textit{Cities};
\item \textit{Cities:} contenente i nomi delle città per le quali è presente almeno una
rilevazione nella relazione \textit{Weather detection}.
\end{itemize}
Lo schema logico prodotto è mostrato in figura~\ref{fig:weather_detection_logic}.
La relazione uno a molti tra l'entità \textit{Weather\_sensor} dello schema concettuale e
l'entità \textit{City} è stata trasformata in una relazione uno a uno in quanto, considerato 
a regime il numero di sensori di molto superiore al numero di città osservate, l'aggiunta di
due attributi alla relazione \textit{Cities} atti ad identificare un sensore in essa presente,
avrebbe comportato la presenza di ridondanza nei dati memorizzati.

\begin{figure}[H]                                                                                                                                                            
\centering                                                                                                                                                                   
\includegraphics{diagrams/weather_detection_logic}                                                                                                                                   
\caption{Schema logico Weather detections}                                                                                                                                            
\label{fig:weather_detection_logic}                                                                                                                                                           
\end{figure}

\section{Scioperi}

\subsection{API REST}

\subsection{Progettazione concettuale}

In figura~\ref{fig:strikes_er} è presente il diagramma entità relazione per i dati
ottenuti dall'API descritta al punto precedente.
Le istanze dell'entità \textit{Strike} sono identificate univocamente dalla chiave composta
dagli attributi \textit{start\_time}, \textit{end\_time}, \textit{name} e \textit{City}.

\begin{figure}                                                                                                                                                            
\centering                                                                                                                                                                   
\includegraphics{diagrams/strikes_er}                                                                                                                                   
\caption{Diagramma ER Strike-City}                                                                                                                                            
\label{fig:strikes_er}                                                                                                                                                           
\end{figure}

\subsection{Progettazione logica}

Lo schema logico è mostrato in figura~\ref{fig:strikes_logic}.
Presupponendo il numero di scioperi di molto inferiore rispetto al numero di profilazioni
ottenute con le precedenti due sorgenti dati, è stata definita una sola relazione
\textit{Strikes} avente gli stessi attributi dell'entità \textit{Strike} del precedente 
schema ER.

\begin{figure}                                                                                                                                                            
\centering                                                                                                                                                                   
\includegraphics{diagrams/strikes_logic}                                                                                                                                   
\caption{Schema logico Strikes}                                                                                                                                            
\label{fig:strikes_logic}                                                                                                                                                           
\end{figure}
